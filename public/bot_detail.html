<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="detail-title">Bot Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .detail-nav { background-color: #34495e; }
        .detail-nav .nav-link { color: #bdc3c7; }
        .detail-nav .nav-link.active { color: white; background-color: #2c3e50; }
        .console-container { height: 75vh; overflow-y: scroll; padding: 15px; background-color: #1e1e1e; color: #00ff00; font-family: 'Consolas', 'Courier New', monospace; border-radius: 5px; }
        .log-line { white-space: pre-wrap; word-wrap: break-word; line-height: 1.2; }
        #modal-editor-container { height: 60vh; width: 100%; border: 1px solid #ccc; }
    </style>
</head>
<body>
<div class="container-fluid p-0">
    <header class="detail-nav p-3 shadow-sm sticky-top">
        <div class="d-flex justify-content-between align-items-center">
            <h4 id="bot-name-display" class="text-white mb-0"><i class="fas fa-robot me-2"></i> Loading...</h4>
            <div>
                <a href="dashboard.html#dashboard" class="btn btn-outline-light btn-sm me-2"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
                <button class="btn btn-warning btn-sm" id="global-restart-btn"><i class="fas fa-redo-alt me-1"></i> Restart Bot</button>
            </div>
        </div>
    </header>

    <ul class="nav nav-tabs detail-nav" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-route="console" href="#console"><i class="fas fa-terminal me-2"></i> Live Console</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-route="filemanager" href="#filemanager"><i class="fas fa-folder-open me-2"></i> File Manager</a>
        </li>
    </ul>

    <div class="container-fluid py-4">
        <div id="console-section" class="content-section">
            <div id="dependency-controls" class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                 <span><i class="fas fa-cogs me-2"></i> Quick Actions:</span>
                 <div>
                    <button class="btn btn-sm btn-success me-2" onclick="controlBot(currentBotName, 'start')"><i class="fas fa-play"></i> Start</button>
                    <button class="btn btn-sm btn-warning me-2" onclick="controlBot(currentBotName, 'restart')"><i class="fas fa-redo-alt"></i> Restart</button>
                    <button class="btn btn-sm btn-danger me-2" onclick="controlBot(currentBotName, 'stop')"><i class="fas fa-stop"></i> Stop</button>
                    <button class="btn btn-sm btn-primary" id="install-deps-btn" onclick="installDependencies(currentBotName, currentBotRuntime)"><i class="fas fa-cogs me-1"></i> Install Dependencies</button>
                </div>
            </div>
            
            <div id="console-output" class="console-container shadow-lg">
                [CONNECTING TO SERVER...]
            </div>
        </div>

        <div id="filemanager-section" class="content-section d-none">
            <div class="row mb-3 align-items-center">
                <div class="col-md-7">
                    <h5 id="current-path-display" class="mb-0 text-secondary"><i class="fas fa-map-marker-alt me-1"></i> Path: /projects/...</h5>
                </div>
                <div class="col-md-5 text-end">
                    <button class="btn btn-sm btn-info me-2" data-bs-toggle="modal" data-bs-target="#newFileModal"><i class="fas fa-plus me-1"></i> New Item</button>
                    <button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#uploadModal"><i class="fas fa-cloud-upload-alt me-1"></i> Upload File</button>
                    <button class="btn btn-sm btn-danger" id="delete-massal-btn" disabled onclick="deleteMassal()"><i class="fas fa-trash-alt me-1"></i> Delete Selected (0)</button>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-body p-0">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 5%;"><input type="checkbox" id="selectAllFiles"></th>
                                <th style="width: 50%;">Name</th>
                                <th style="width: 15%;">Size</th>
                                <th style="width: 15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="file-list-tbody">
                            <tr><td colspan="4" class="text-center text-muted">Loading files...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newFileModal" tabindex="-1" aria-labelledby="newFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFileModalLabel">Create New Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Type:</label>
                    <select id="new-item-type" class="form-select" onchange="toggleContentArea(this.value)">
                        <option value="file">New File</option>
                        <option value="folder">New Folder</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="new-item-name" class="form-label">Item Name:</label>
                    <input type="text" class="form-control" id="new-item-name" required>
                </div>
                <div id="file-content-area" class="mb-3">
                    <label for="new-file-content" class="form-label">Initial File Content (Optional):</label>
                    <textarea class="form-control" id="new-file-content" rows="5"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createFileOrFolder()"><i class="fas fa-check me-1"></i> Create</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editFileModal" tabindex="-1" aria-labelledby="editFileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFileModalLabel">Edit File: <span id="editing-filename"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modal-editor-container"></div>
                <div id="modal-editor-status" class="mt-2 small text-muted"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="save-modal-btn" onclick="saveFileModal()"><i class="fas fa-save me-1"></i> Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title"><i class="fas fa-upload me-2"></i> Upload File</h5></div>
            <div class="modal-body">
                <form id="fileUploadForm">
                    <input type="file" class="form-control mb-3" name="file" id="fileToUpload" required>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" value="1" id="extractZipCheck" checked>
                        <label class="form-check-label" for="extractZipCheck">
                            Auto Extract & Delete ZIP (if .zip)
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="uploadFileBtn"><i class="fas fa-cloud-upload-alt me-1"></i> Upload</button>
                    <div id="uploadStatus" class="mt-3"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    let currentBotName;
    let currentBotRuntime; 
    let socket;
    let modalEditor; 
    let currentFileInModal;
    let selectedFiles = []; 

    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    
    async function apiFetch(url, method = 'GET', body = null) {
        const options = { method, headers: {} };
        if (body) {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Failed to process server response' }));
            throw new Error(errorData.message || `API Error: ${response.status}`);
        }
        return response.json();
    }
    
    async function controlBot(name, action) {
         try {
             const data = await apiFetch('/api/control', 'POST', { name, action });
             alert(`Action ${action.toUpperCase()} (${name}) successful: ${data.message}`);
         } catch (error) {
             alert(`Action failed: ${error.message}`);
         }
    }
    
    function appendLog(message, type = 'log') {
        const consoleOutput = document.getElementById('console-output');
        const pre = document.createElement('div');
        pre.classList.add('log-line');
        pre.textContent = message;
        
        let color = '#00ff00';
        if (type === 'error') color = '#ff6b6b'; 
        else if (type === 'info') color = '#ffd700'; 
        else if (type === 'system') color = '#7fffd4'; 

        pre.style.color = color;
        consoleOutput.appendChild(pre);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function navigateDetail(hash) {
        const route = hash.replace('#', '');
        document.querySelectorAll('.content-section').forEach(el => el.classList.add('d-none'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        
        let sectionToShow = document.getElementById(`${route}-section`);
        if (sectionToShow) {
             sectionToShow.classList.remove('d-none');
             document.querySelector(`[data-route="${route}"]`)?.classList.add('active');
             
             if (route === 'filemanager') loadFileManager(currentBotName);
             else if (route === 'console') startConsole(currentBotName);
        }
    }
    
    async function getBotRuntime(botName) {
        try {
            const statusData = await apiFetch('/api/status');
            const bot = statusData.bots.find(b => b.name === botName);
            if (bot) currentBotRuntime = bot.runtime || 'node';
        } catch (e) {
            currentBotRuntime = 'node'; 
        }
    }

    // --- CONSOLE & INSTALL LOGIC ---
    function startConsole(botName) {
        if (!socket) socket = io();

        socket.off('connect').on('connect', () => {
            appendLog('[SYSTEM] Socket Connected.', 'system');
            document.getElementById('console-output').innerHTML = '';
            socket.emit('join_console', botName);
            appendLog('[SYSTEM] Starting bot log stream...\n', 'info');
        });

        socket.off('log_output').on('log_output', (data) => {
             if (document.getElementById('console-section').classList.contains('d-none')) return;
             appendLog(data.toString());
        });

        socket.off('disconnect').on('disconnect', () => appendLog('\n[SYSTEM] Connection disconnected.', 'error'));
        
        socket.off('install_output');
        socket.off('install_complete');
    }
    
    async function installDependencies(botName, runtime) {
        if (!confirm(`Are you sure you want to run dependency install (${runtime}) for ${botName}? Check the Console tab!`)) return;

        window.location.hash = '#console';
        const installBtn = document.getElementById('install-deps-btn');
        installBtn.disabled = true;
        
        appendLog(`\n--- Starting installation (${runtime})... ---`, 'system');

        try {
            const data = await apiFetch('/api/install_dependencies', 'POST', { name: botName, runtime });
            appendLog(`[SYSTEM] ${data.message}`, 'info');
            
            if (data.socketId) {
                socket.emit('join_install_stream', data.socketId);
                
                socket.on('install_output', (output) => appendLog(output, 'log'));

                socket.on('install_complete', (result) => {
                    const message = `INSTALLATION FINISHED. Exit code: ${result.code}. Status: ${result.status}`;
                    appendLog(`\n--- ${message} ---\n`, result.status === 'SUCCESS' ? 'system' : 'error');
                    installBtn.disabled = false;
                });
            }

        } catch (e) {
            appendLog(`\n[SYSTEM] FAILED TO START INSTALLATION: ${e.message}\n`, 'error');
            installBtn.disabled = false;
        }
    }

    // --- FILE MANAGER LOGIC ---
    async function loadFileManager(botName) {
        if (!currentBotRuntime) await getBotRuntime(botName);
        const tbody = document.getElementById('file-list-tbody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-primary"><i class="fas fa-spinner fa-spin me-2"></i> Fetching files...</td></tr>';
        
        try {
            const data = await apiFetch(`/api/filemanager/list?name=${botName}`);
            selectedFiles = []; 
            updateDeleteButton();

            const directories = data.files.filter(f => f.type === 'directory').sort((a, b) => a.name.localeCompare(b.name));
            const files = data.files.filter(f => f.type === 'file').sort((a, b) => a.name.localeCompare(b.name));
            const allItems = [...directories, ...files];

            document.getElementById('current-path-display').innerHTML = `<i class="fas fa-map-marker-alt me-1"></i> Path: ${data.path}`;

            tbody.innerHTML = allItems.map(item => {
                const icon = item.type === 'directory' ? '<i class="fas fa-folder text-warning me-2"></i>' : '<i class="fas fa-file-alt text-secondary me-2"></i>';
                const size = item.type === 'directory' ? '-' : formatBytes(item.size);
                const isZip = item.name.endsWith('.zip') && item.type === 'file';
                
                return `
                    <tr>
                        <td><input type="checkbox" class="file-select-checkbox" data-filename="${item.name}"></td>
                        <td>${icon} <a href="#" class="${item.type === 'file' ? 'edit-file-link' : 'text-dark'}" data-file="${item.name}">${item.name}</a></td>
                        <td>${size}</td>
                        <td>
                            ${isZip ? `<button class="btn btn-sm btn-warning btn-extract me-2" data-file="${item.name}"><i class="fas fa-download me-1"></i>Extract</button>` : ''}
                            <button class="btn btn-sm btn-outline-danger btn-delete-single" data-file="${item.name}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            attachFileManagerListeners(botName);

        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Failed to load File Manager: ${e.message}</td></tr>`;
        }
    }

    function attachFileManagerListeners(botName) {
        document.getElementById('selectAllFiles').addEventListener('change', (e) => {
            document.querySelectorAll('.file-select-checkbox').forEach(cb => cb.checked = e.target.checked);
            updateSelectedFiles();
        });
        document.querySelectorAll('.file-select-checkbox').forEach(cb => cb.addEventListener('change', updateSelectedFiles));
        document.querySelectorAll('.btn-extract').forEach(btn => btn.addEventListener('click', () => extractZip(botName, btn.dataset.file)));
        document.querySelectorAll('.btn-delete-single').forEach(btn => btn.addEventListener('click', () => deleteMassal([btn.dataset.file])));
        document.querySelectorAll('.edit-file-link').forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            openFileInModal(botName, link.dataset.file);
        }));
    }
    
    function updateDeleteButton() {
        const deleteBtn = document.getElementById('delete-massal-btn');
        deleteBtn.textContent = `ðŸ—‘ï¸ Delete Selected (${selectedFiles.length})`;
        deleteBtn.disabled = selectedFiles.length === 0;
    }
    
    function updateSelectedFiles() {
        selectedFiles = Array.from(document.querySelectorAll('.file-select-checkbox:checked'))
                            .map(cb => cb.dataset.filename)
                            .filter(name => name);
        updateDeleteButton();
    }

    async function deleteMassal(itemsToDelete = selectedFiles) {
        if (itemsToDelete.length === 0) return;
        if (!confirm(`Are you sure you want to permanently delete ${itemsToDelete.length} items?`)) return;

        try {
            const data = await apiFetch('/api/filemanager/action', 'POST', {
                name: currentBotName,
                action: 'delete_massal',
                items: itemsToDelete
            });
            alert(data.message);
            loadFileManager(currentBotName); 
        } catch (e) {
            alert(`Failed to delete: ${e.message}`);
        }
    }

    async function extractZip(botName, zipFileName) {
        if (!confirm(`Are you sure you want to extract ${zipFileName} here and delete the original ZIP file?`)) return;

        try {
            const data = await apiFetch('/api/filemanager/action', 'POST', {
                name: botName,
                action: 'extract_zip',
                target: zipFileName
            });
            alert(data.message);
            loadFileManager(currentBotName); 
        } catch (e) {
            alert(`Failed to extract ZIP: ${e.message}`);
        }
    }
    
    function toggleContentArea(type) {
         document.getElementById('file-content-area').style.display = type === 'file' ? 'block' : 'none';
    }

    async function createFileOrFolder() {
        const type = document.getElementById('new-item-type').value;
        const target = document.getElementById('new-item-name').value.trim();
        const content = document.getElementById('new-file-content').value;
        const modal = bootstrap.Modal.getInstance(document.getElementById('newFileModal'));

        if (!target) {
            alert('File/Folder name cannot be empty.');
            return;
        }

        try {
            const data = await apiFetch('/api/filemanager/action', 'POST', {
                name: currentBotName,
                action: 'create',
                type: type,
                target: target,
                content: type === 'file' ? content : undefined
            });
            
            alert(data.message);
            modal.hide();
            loadFileManager(currentBotName); 
            
        } catch (e) {
            alert(`Failed to create item: ${e.message}`);
        }
    }

    // --- UPLOAD LOGIC ---
    document.getElementById('fileUploadForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('fileToUpload');
        const statusDiv = document.getElementById('uploadStatus');
        const uploadBtn = document.getElementById('uploadFileBtn');
        const extractChecked = document.getElementById('extractZipCheck').checked;

        if (fileInput.files.length === 0) return;
        const file = fileInput.files[0];

        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i> Uploading...</div>';
        uploadBtn.disabled = true;

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('botName', currentBotName); 

            const response = await fetch('/api/filemanager/upload', { method: 'POST', body: formData });
            const data = await response.json();
            
            if (data.status !== 'success') throw new Error(data.message);

            statusDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            
            if (file.name.endsWith('.zip') && extractChecked) {
                statusDiv.innerHTML += '<div class="alert alert-warning"><i class="fas fa-sync-alt me-2"></i> Extracting ZIP...</div>';
                await extractZip(currentBotName, file.name); 
            }

            loadFileManager(currentBotName);
            setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide(), 1000);

        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-danger">ERROR: ${error.message}</div>`;
        } finally {
            uploadBtn.disabled = false;
        }
    });

    // --- EDITOR MODAL LOGIC ---
    function initModalEditor() {
         if (!modalEditor) {
             modalEditor = ace.edit("modal-editor-container");
             modalEditor.setTheme("ace/theme/monokai");
             modalEditor.session.setMode("ace/mode/javascript");
             modalEditor.session.setTabSize(4);
         }
    }

    async function openFileInModal(botName, fileName) {
        initModalEditor();
        currentFileInModal = fileName;
        document.getElementById('editing-filename').textContent = fileName;
        document.getElementById('save-modal-btn').disabled = true;
        document.getElementById('modal-editor-status').textContent = 'Loading...';
        const modalEl = document.getElementById('editFileModal');
        const modal = new bootstrap.Modal(modalEl);

        try {
            const data = await apiFetch(`/api/editor/load?name=${botName}&file=${fileName}`);
            modalEditor.setValue(data.content, -1);
            modalEditor.setReadOnly(false);
            
            let mode = 'text';
            if (fileName.endsWith('.js') || fileName.endsWith('.json')) mode = 'javascript';
            else if (fileName.endsWith('.py')) mode = 'python';
            else if (fileName.endsWith('.html') || fileName.endsWith('.css')) mode = 'html';
            modalEditor.session.setMode(`ace/mode/${mode}`);

            document.getElementById('save-modal-btn').disabled = false;
            document.getElementById('modal-editor-status').textContent = `Status: Ready to edit. Mode: ${mode}`;
            modal.show();
            setTimeout(() => modalEditor.resize(), 300); 

        } catch (e) {
            document.getElementById('modal-editor-status').textContent = `Status: Failed to load file content: ${e.message}`;
            modalEditor.setValue(`Failed to load file ${fileName}: ${e.message}`, -1);
            modalEditor.setReadOnly(true);
            modal.show();
        }
    }

    async function saveFileModal() {
         if (!currentFileInModal || modalEditor.getReadOnly()) return;

         const content = modalEditor.getValue();
         const saveBtn = document.getElementById('save-modal-btn');
         const statusDiv = document.getElementById('modal-editor-status');

         saveBtn.disabled = true;
         statusDiv.innerHTML = '<span class="text-warning"><i class="fas fa-spinner fa-spin"></i> Saving...</span>';

         try {
             const data = await apiFetch('/api/editor/save', 'POST', { name: currentBotName, file: currentFileInModal, content });
             statusDiv.innerHTML = data.status === 'success' ? 
                 '<span class="text-success"><i class="fas fa-check-circle"></i> Saved successfully!</span>' :
                 `<span class="text-danger"><i class="fas fa-times-circle"></i> Failed to save: ${data.message}</span>`;
         } catch (e) {
             statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-network-wired"></i> Server connection failed while saving: ${e.message}</span>`;
         } finally {
             saveBtn.disabled = false;
         }
    }


    document.addEventListener('DOMContentLoaded', async () => {
        initModalEditor();
        const params = new URLSearchParams(window.location.search);
        currentBotName = params.get('name');
        
        if (!currentBotName) {
            window.location.href = 'dashboard.html#dashboard';
            return;
        }

        await getBotRuntime(currentBotName); 

        document.getElementById('detail-title').textContent = `Detail | ${currentBotName}`;
        document.getElementById('bot-name-display').innerHTML = `<i class="fas fa-robot me-2"></i> Bot: ${currentBotName}`;
        document.getElementById('global-restart-btn').addEventListener('click', () => controlBot(currentBotName, 'restart'));

        window.addEventListener('hashchange', () => navigateDetail(window.location.hash || '#console'));

        navigateDetail(window.location.hash || '#console');
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
