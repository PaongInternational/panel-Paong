<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Paong v1.0.0 | Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; }
        #sidebar { 
            min-height: 100vh; 
            background: #2c3e50; 
            color: white; 
            padding-top: 20px; 
            width: 250px; 
            transition: margin-left 0.3s;
        }
        .nav-link { color: #bdc3c7; border-radius: 5px; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { color: white; background-color: #34495e; }
        .main-content { padding: 30px; }
        @media (max-width: 768px) {
            #sidebar { margin-left: -250px; position: fixed; z-index: 1050; }
            #sidebar.active { margin-left: 0; }
            .content-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1040; }
        }
    </style>
</head>
<body>
<div class="d-flex" id="wrapper">
    <div id="sidebar" class="d-flex flex-column">
        <div class="p-3 text-white border-bottom border-secondary mb-3 text-center">
            <h5 class="mb-0"><i class="fas fa-paw me-2"></i> Panel Paong v1.0.0</h5>
            <small>Dev: Paong & Evelyn</small>
        </div>
        <div class="nav flex-column px-3">
            <a href="#dashboard" class="nav-link active" data-route="dashboard"><i class="fas fa-chart-line me-2"></i> Dashboard</a>
            <a href="#deploy" class="nav-link" data-route="deploy"><i class="fas fa-cloud-upload-alt me-2"></i> Deploy Bot</a>
        </div>
        
        <hr class="text-secondary mx-3">
        
        <div class="p-3 text-secondary pt-0 small">
            <h6 class="text-white"><i class="fas fa-server me-2"></i> System Info:</h6>
            <p id="sys-node" class="mb-1"></p>
            <p id="sys-python" class="mb-1"></p>
            <p id="sys-load" class="mb-1"></p>
            <p id="sys-mem" class="mb-1"></p>
            <p id="sys-disk" class="mb-1"></p>
        </div>
    </div>
    <div id="content-overlay" class="content-overlay d-md-none"></div>

    <div id="page-content-wrapper" class="flex-grow-1">
        <nav class="navbar navbar-light bg-white border-bottom shadow-sm sticky-top">
            <div class="container-fluid">
                <button class="btn btn-outline-secondary d-md-none me-3" id="sidebarToggle"><i class="fas fa-bars"></i></button>
                <h4 class="mb-0" id="mainTitle">Dashboard</h4>
            </div>
        </nav>

        <div class="container-fluid main-content">
            <div id="dashboard-section" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0 text-primary"><i class="fas fa-robot me-2"></i> ACTIVE BOT MANAGEMENT</h1>
                    <button class="btn btn-primary" onclick="fetchStatus()"><i class="fas fa-sync-alt me-2"></i> Refresh</button>
                </div>
                
                <div id="bot-panels" class="row">
                    <div class="col-12"><p class="text-muted">Loading bot data...</p></div>
                </div>
            </div>

            <div id="deploy-section" class="content-section d-none">
                <h2 class="mb-4 text-success"><i class="fas fa-cloud-upload-alt me-2"></i> Deploy New Bot</h2>
                <div class="card shadow p-4">
                    <form id="deployForm" class="mt-4">
                        <div class="mb-3">
                            <label for="botZip" class="form-label">Bot ZIP File (*Required):</label>
                            <input type="file" class="form-control" id="botZip" name="botZip" accept=".zip" required>
                        </div>
                        <div class="mb-3">
                            <label for="botName" class="form-label">Bot Name (PM2 ID):</label>
                            <input type="text" class="form-control" id="botName" name="botName" placeholder="Example: my-whatsapp-bot">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="runtime" class="form-label">Select Runtime (*Required):</label>
                                <select class="form-select" id="runtime" name="runtime" required>
                                    <option value="node">Node.js (System Default)</option>
                                    <option value="node@24">Node.js v24 (Latest)</option>
                                    <option value="node@23">Node.js v23</option>
                                    <option value="node@22">Node.js v22</option>
                                    <option value="node@21">Node.js v21</option>
                                    <option value="node@20">Node.js v20 (LTS)</option>
                                    <option value="node@19">Node.js v19</option>
                                    <option value="node@18">Node.js v18 (LTS)</option>
                                    <option value="python">Python 3</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="entryFile" class="form-label">Entry File (Start Script):</label>
                                <input type="text" class="form-control" id="entryFile" name="entryFile" value="index.js" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success mt-3 w-100" id="deployBtn"><i class="fas fa-terminal me-2"></i> Deploy & Start</button>
                        <div id="statusMessage" class="mt-3"></div>
                    </form>
                </div>
            </div>
            
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentRoute = 'dashboard';
    
    async function apiFetch(url, method = 'GET', body = null) {
        const options = { method, headers: {} };
        if (body) {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Failed to process server response' }));
            throw new Error(errorData.message || `API Error: ${response.status}`);
        }
        return response.json();
    }

    function navigate(hash) {
        const route = hash.replace('#', '').split('?')[0];
        document.querySelectorAll('.content-section').forEach(el => el.classList.add('d-none'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        currentRoute = route;

        let sectionToShow = document.getElementById(`${route}-section`);
        if (sectionToShow) {
             sectionToShow.classList.remove('d-none');
             document.getElementById('mainTitle').textContent = route.toUpperCase();
             document.querySelector(`[data-route="${route}"]`)?.classList.add('active');
        } else {
             document.getElementById('dashboard-section').classList.remove('d-none');
        }
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('content-overlay').style.display = 'none';
    }

    async function controlBot(name, action) {
        if (action === 'delete' && !confirm(`Are you sure you want to DELETE bot ${name} and ALL its data? This action is permanent!`)) return;
        try {
            const data = await apiFetch('/api/control', 'POST', { name, action });
            alert(`Action ${action.toUpperCase()} (${name}) successful: ${data.message}`);
            fetchStatus();
        } catch (error) {
            alert(`Action failed: ${error.message}`);
        }
    }

    async function fetchStatus() {
        try {
            const data = await apiFetch('/api/status');
            
            // Update System Info
            const sys = data.system;
            document.getElementById('sys-node').innerHTML = `Node: <b>v${sys.nodeVersion}</b>`;
            document.getElementById('sys-python').innerHTML = `Python: <b>${sys.pythonVersion}</b>`;
            document.getElementById('sys-load').innerHTML = `Load (1m): <b>${sys.cpuLoad}</b>`;
            document.getElementById('sys-mem').innerHTML = `Memory: <b>${sys.freeMemory}MB / ${sys.totalMemory}MB</b>`;
            document.getElementById('sys-disk').innerHTML = `Free Disk: <b>${sys.freeDisk}GB / ${sys.totalDisk}GB</b>`;

            // Update Bot Panels
            const panelsContainer = document.getElementById('bot-panels');
            if (data.bots.length === 0) {
                 panelsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info"><i class="fas fa-info-circle me-2"></i> No bots currently deployed.</div></div>';
                 return;
            }

            panelsContainer.innerHTML = data.bots.map(bot => {
                const statusMap = { 'online': 'success', 'stopped': 'secondary', 'errored': 'danger', 'stopping': 'warning' };
                const statusColor = statusMap[bot.status] || 'warning';
                const uptimeText = bot.uptime > 0 ? (bot.uptime / 1000 / 60 / 60).toFixed(1) + 'h' : 'N/A';
                const displayRuntime = bot.runtime.replace('node@', 'Node ').toUpperCase();
                
                return `
                    <div class="col-xl-4 col-lg-6 mb-4">
                        <div class="card shadow bot-card border-top border-4 border-${statusColor}">
                            <div class="card-header bot-card-header bg-${statusColor} bg-gradient text-white">
                                <h5 class="mb-0">${bot.name}</h5>
                                <span class="badge text-bg-light float-end">${displayRuntime}</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text mb-1 small text-muted">Script: <code>${bot.script}</code></p>
                                <p class="card-text mb-2">Status: <span class="badge text-bg-${statusColor}"><i class="fas fa-circle me-1"></i> ${bot.status.toUpperCase()}</span></p>
                                
                                <ul class="list-group list-group-flush mb-3">
                                    <li class="list-group-item d-flex justify-content-between align-items-center p-2">
                                        Resource: <span>CPU: <b>${bot.cpu}%</b> | Mem: <b>${bot.memory}MB</b></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center p-2">
                                        Uptime / Restarts: <span>${uptimeText} / <b>${bot.restarts}</b></span>
                                    </li>
                                </ul>
                                
                                <div class="d-grid gap-2">
                                    <a href="bot_detail.html?name=${bot.name}#console" class="btn btn-sm btn-info text-white"><i class="fas fa-terminal me-2"></i>Console & File Manager</a>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-warning" onclick="controlBot('${bot.name}', 'restart')"><i class="fas fa-redo-alt"></i> Restart</button>
                                        <button class="btn btn-sm btn-danger" onclick="controlBot('${bot.name}', 'stop')"><i class="fas fa-stop"></i> Stop</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="controlBot('${bot.name}', 'delete')"><i class="fas fa-trash-alt"></i> Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Failed to fetch status:', error);
            document.getElementById('bot-panels').innerHTML = `<div class="col-12"><div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> Failed to connect to server: ${error.message}</div></div>`;
        }
    }
    
    document.getElementById('deployForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const statusDiv = document.getElementById('statusMessage');
        const deployBtn = document.getElementById('deployBtn');

        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i> Uploading & Deploying...</div>';
        deployBtn.disabled = true;

        try {
            const response = await fetch('/api/deploy', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.status === 'success') {
                statusDiv.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i> ${data.message} | Redirecting...</div>`;
                setTimeout(() => window.location.hash = '#dashboard', 2000);
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i> DEPLOY ERROR: ${data.message}</div>`;
            }

        } catch (error) {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-network-wired me-2"></i> Network/Server ERROR: ${error.message}</div>`;
        } finally {
            deployBtn.disabled = false;
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('content-overlay').style.display = document.getElementById('sidebar').classList.contains('active') ? 'block' : 'none';
        });
        document.getElementById('content-overlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('content-overlay').style.display = 'none';
        });
        
        window.addEventListener('hashchange', () => navigate(window.location.hash || '#dashboard'));

        navigate(window.location.hash || '#dashboard');
        fetchStatus();

        setInterval(() => {
            if (currentRoute === 'dashboard') {
                fetchStatus();
            }
        }, 7000); 
    });
</script>
</body>
</html>
